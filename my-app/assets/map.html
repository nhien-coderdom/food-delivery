<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drone Map</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Mapbox GL JS v1.13 â€” phÃ¹ há»£p WebView -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css"
    rel="stylesheet"
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>

<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
/* ============================================================
   GLOBAL STATE
============================================================ */
let ORDER_ID = null;
let RESTAURANT = null;
let CUSTOMER = null;
let STATUS = null;
let API_URL = "http://172.20.10.3:1337";

let WAREHOUSE = { lat: 10.760596, lng: 106.681948 };

let routeCoords = [];
let socket = null;

let mapLoaded = false;

// ngÄƒn reset route nhiá»u láº§n
let DRONE_STARTED = false;

/* ============================================================
   INIT MAP
============================================================ */
mapboxgl.accessToken = "pk.eyJ1IjoibmduaGllbiIsImEiOiJjbWh0MWpsc3oxcnplMmxvOTJmNnJqMnZlIn0.s2xJurMq7xiCUGhPUHeTEg";

const map = new mapboxgl.Map({
  container: "map",
  style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
  center: [WAREHOUSE.lng, WAREHOUSE.lat],
  zoom: 13
});

let droneMarker = null;
let warehouseMarker = null;
let restaurantMarker = null;
let customerMarker = null;

map.on("load", () => {
  mapLoaded = true;
  if (routeCoords.length > 1) updateRoute();
});

/* ============================================================
   DRAW MARKERS
============================================================ */
function drawMarkers() {
  if (!warehouseMarker) {
    warehouseMarker = new mapboxgl.Marker({ color: "#0066ff" })
      .setLngLat([WAREHOUSE.lng, WAREHOUSE.lat])
      .addTo(map);
  }

  if (RESTAURANT && !restaurantMarker) {
    restaurantMarker = new mapboxgl.Marker({ color: "#00c853" })
      .setLngLat([RESTAURANT.lng, RESTAURANT.lat])
      .addTo(map);
  }

  if (CUSTOMER && !customerMarker) {
    customerMarker = new mapboxgl.Marker({ color: "#ff1744" })
      .setLngLat([CUSTOMER.lng, CUSTOMER.lat])
      .addTo(map);
  }
}

/* ============================================================
   UPDATE ROUTE
============================================================ */
function updateRoute() {
  if (!mapLoaded) {
    map.once("load", updateRoute);
    return;
  }

  if (routeCoords.length < 2) return;

  const geo = {
    type: "Feature",
    geometry: { type: "LineString", coordinates: routeCoords }
  };

  if (map.getSource("route-src")) {
    map.getSource("route-src").setData(geo);
  } else {
    map.addSource("route-src", { type: "geojson", data: geo });

    map.addLayer({
      id: "route-line",
      type: "line",
      source: "route-src",
      paint: {
        "line-color": "#FF6B35",
        "line-width": 4
      }
    });
  }
}

/* ============================================================
   SOCKET REALTIME
============================================================ */
function connectSocket() {
  if (!ORDER_ID) return;

  socket = io(API_URL, {
    transports: ["websocket"],
    path: "/socket.io/"
  });

  socket.on("connect", () => {
    console.log("ðŸŸ¢ SOCKET CONNECTED");

    // â­ JOIN ROOM CHUáº¨N BACKEND: order_12345
    socket.emit("drone:join", `order_${ORDER_ID}`);
  });

  socket.on("drone:position", (d) => {
    if (String(d.orderID) !== String(ORDER_ID)) return;

    const pos = [d.lng, d.lat];

    routeCoords.push(pos);
    updateRoute();

    if (!droneMarker) {
      droneMarker = new mapboxgl.Marker({ color: "orange" })
        .setLngLat(pos)
        .addTo(map);
    } else {
      droneMarker.setLngLat(pos);
    }

    map.flyTo({ center: pos, zoom: 15 });
  });
}

/* ============================================================
   RECEIVE MESSAGE FROM React Native
============================================================ */
function handleMessage(event) {
  let data;
  try {
    data = JSON.parse(event.data);
  } catch (e) {
    return;
  }

  console.log("ðŸ“¨ RECEIVED FROM RN:", data);

  ORDER_ID = data.orderId;
  RESTAURANT = data.restaurant;
  CUSTOMER = data.customer;
  STATUS = data.statusOrder;
  API_URL = data.apiUrl;

  drawMarkers();

  /* ------------------------------
     CASE 1 â€” ÄÃƒ GIAO (delivered)
  ------------------------------ */
  if (STATUS === "delivered" && Array.isArray(data.route)) {
    routeCoords = data.route.map((p) => [p.lng, p.lat]);
    updateRoute();

    if (routeCoords.length > 0) {
      const last = routeCoords.at(-1);
      droneMarker = new mapboxgl.Marker({ color: "orange" })
        .setLngLat(last)
        .addTo(map);
    }
  }

  /* ------------------------------
     CASE 2 â€” READY (báº¯t Ä‘áº§u hÃ nh trÃ¬nh)
  ------------------------------ */
  if (STATUS === "ready" && !DRONE_STARTED) {
    DRONE_STARTED = true;

    routeCoords = [];

    fetch(`${API_URL}/api/orders/trigger-drone/${ORDER_ID}`, {
      method: "POST"
    }).catch(console.log);
  }

  /* ------------------------------
     CASE 3 â€” REALTIME (drone bay)
  ------------------------------ */
  if (STATUS === "ready" || STATUS === "delivering") {
    connectSocket();
  }
}

/* Android */
document.addEventListener("message", handleMessage);
/* iOS */
window.addEventListener("message", handleMessage);

</script>

</body>
</html>
